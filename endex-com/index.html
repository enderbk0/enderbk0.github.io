<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Endex - Full Content Search</title>
  <!-- Base URL for correct root-relative resolving -->
  <base href="https://enderbk0.github.io/">
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #0c0c0c;
      color: #eee;
      padding: 2em;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }
    header {
      text-align: center;
      margin-bottom: 1em;
    }
    header h1 {
      margin: 0.2em 0;
      font-size: 2.4em;
      font-weight: 900;
      letter-spacing: 0.1em;
      color: #00bfff;
    }
    #search-container {
      max-width: 700px;
      margin: 0 auto 1em;
      width: 100%;
    }
    #search-input {
      width: 100%;
      padding: 0.75em 1em;
      font-size: 1.2em;
      border-radius: 10px;
      border: none;
      outline: none;
      box-shadow: 0 0 8px #00bfff88;
      background: #121212;
      color: #eee;
      transition: box-shadow 0.3s ease;
    }
    #search-input:focus {
      box-shadow: 0 0 12px #00bfffcc;
    }
    #results {
      max-width: 700px;
      margin: 0 auto;
      margin-top: 1em;
    }
    .result {
      background: #1c1c1c;
      border-radius: 8px;
      padding: 1em;
      margin-bottom: 1em;
      border: 1px solid #333;
    }
    .result a.title {
      color: #00bfff;
      font-size: 1.3em;
      font-weight: bold;
      text-decoration: none;
    }
    .result a.title:hover {
      text-decoration: underline;
    }
    .result .url {
      color: #555;
      font-size: 0.9em;
      margin: 0.3em 0;
      user-select: all;
    }
    .result .snippet {
      color: #ccc;
      font-size: 1em;
      line-height: 1.3;
      white-space: pre-wrap;
    }
    #status {
      max-width: 700px;
      margin: 2em auto;
      color: #666;
      font-style: italic;
      text-align: center;
      user-select: none;
    }
  </style>
</head>
<body>
  <header>
    <h1>Endex</h1>
    <p style="color:#555;">Search content in all hosted pages</p>
  </header>

  <div id="search-container">
    <input type="search" id="search-input" placeholder="Type keywords and press Enter to search" aria-label="Search" autocomplete="off" />
  </div>

  <div id="status">Loading index, please wait...</div>
  <div id="results"></div>

<script>
(async () => {
  const repo = "enderbk0/enderbk0.github.io";
  const apiBase = `https://api.github.com/repos/${repo}/contents`;
  // Use raw.githubusercontent.com root to fetch raw files
  const rawBase = `https://raw.githubusercontent.com/${repo}/main`;

  const searchInput = document.getElementById("search-input");
  const resultsDiv = document.getElementById("results");
  const statusDiv = document.getElementById("status");

  let htmlFiles = [];

  // Recursively fetch all .html files in repo root and subfolders
  async function fetchFilesRecursively(path = "") {
    const url = `${apiBase}/${path}`;
    const res = await fetch(url);
    if (!res.ok) throw new Error(`GitHub API error: ${res.status}`);
    const items = await res.json();

    let files = [];
    for (const item of items) {
      if (item.type === "dir") {
        files = files.concat(await fetchFilesRecursively(item.path));
      } else if (item.type === "file" && item.name.toLowerCase().endsWith(".html")) {
        files.push(item.path);
      }
    }
    return files;
  }

  // Fetch HTML content, extract title and text snippet
  async function fetchHtmlContent(path) {
    const url = `${rawBase}/${path}?t=${Date.now()}`; // cache-bust
    try {
      const res = await fetch(url);
      if (!res.ok) throw new Error(`Failed to fetch ${path}`);
      const htmlText = await res.text();

      // Parse title
      const titleMatch = htmlText.match(/<title>(.*?)<\/title>/i);
      const title = titleMatch ? titleMatch[1] : path;

      // Strip HTML tags for snippet
      const tempDiv = document.createElement("div");
      tempDiv.innerHTML = htmlText;
      const textContent = tempDiv.textContent || tempDiv.innerText || "";

      return { path, url: `./${path}`, title, textContent };
    } catch (e) {
      console.warn(e);
      return null;
    }
  }

  // Build search index by fetching all html files + contents
  async function buildIndex() {
    statusDiv.textContent = "Fetching file list...";
    const files = await fetchFilesRecursively();

    statusDiv.textContent = `Found ${files.length} HTML files. Fetching contents...`;

    const results = [];
    for (let i = 0; i < files.length; i++) {
      statusDiv.textContent = `Fetching content ${i + 1} / ${files.length}...`;
      const content = await fetchHtmlContent(files[i]);
      if (content) results.push(content);
    }

    statusDiv.textContent = `Indexing completed. ${results.length} pages ready.`;
    return results;
  }

  let index = [];

  // Show search results
  function showResults(results) {
    resultsDiv.innerHTML = "";
    if (results.length === 0) {
      resultsDiv.innerHTML = "<p>No results found.</p>";
      return;
    }
    results.forEach(r => {
      const div = document.createElement("div");
      div.className = "result";

      const query = searchInput.value.trim().toLowerCase();
      const textLower = r.textContent.toLowerCase();
      const pos = textLower.indexOf(query);
      let snippet = "";

      if (pos >= 0) {
        const start = Math.max(0, pos - 50);
        const end = Math.min(r.textContent.length, pos + 150);
        snippet = r.textContent.substring(start, end).replace(/\s+/g, " ");
        snippet = "…" + snippet + "…";
      } else {
        snippet = r.textContent.substring(0, 180).replace(/\s+/g, " ") + "…";
      }

      div.innerHTML = `
        <a href="${r.url}" class="title" target="_blank" rel="noopener noreferrer">${r.title}</a>
        <div class="url">${r.url}</div>
        <div class="snippet">${snippet}</div>
      `;
      resultsDiv.appendChild(div);
    });
  }

  // Search function
  function searchIndex(query) {
    query = query.trim().toLowerCase();
    if (!query) {
      resultsDiv.innerHTML = "";
      statusDiv.textContent = "Please enter search keywords and press Enter.";
      return;
    }
    statusDiv.textContent = `Searching for "${query}"...`;

    const filtered = index.filter(p => p.textContent.toLowerCase().includes(query) || p.title.toLowerCase().includes(query));
    statusDiv.textContent = `Found ${filtered.length} result(s) for "${query}".`;
    showResults(filtered);
  }

  // Build index at page load
  try {
    index = await buildIndex();
    statusDiv.textContent = "Ready. Type your search and press Enter.";
  } catch (e) {
    statusDiv.textContent = "Failed to build search index. Try refreshing.";
    console.error(e);
  }

  // Search on Enter key
  searchInput.addEventListener("keydown", e => {
    if (e.key === "Enter") {
      searchIndex(searchInput.value);
    }
  });
})();
</script>
</body>
</html>
