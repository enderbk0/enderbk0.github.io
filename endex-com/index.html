<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Endex - Search EnderBK Hosted Pages</title>
  <style>
    body {
      font-family: sans-serif;
      background: #0c0c0c;
      color: #eee;
      padding: 2em;
      display: flex;
      flex-direction: column;
      min-height: 100vh;
    }
    header {
      text-align: center;
      margin-bottom: 1em;
    }
    header h1 {
      margin: 0.2em 0;
      font-size: 2.4em;
      font-weight: 900;
      letter-spacing: 0.1em;
      color: #00bfff;
    }
    header p.version {
      font-size: 1em;
      color: #555;
      margin-top: 0.2em;
      font-style: italic;
    }
    #search-container {
      max-width: 600px;
      margin: 0 auto 2em auto;
      width: 100%;
    }
    #search-input {
      width: 100%;
      padding: 0.75em 1em;
      font-size: 1.2em;
      border-radius: 10px;
      border: none;
      outline: none;
      box-shadow: 0 0 8px #00bfff88;
      background: #121212;
      color: #eee;
      transition: box-shadow 0.3s ease;
    }
    #search-input:focus {
      box-shadow: 0 0 12px #00bfffcc;
    }
    .page-list {
      display: grid;
      gap: 1em;
      max-width: 800px;
      margin: auto;
      margin-top: auto; /* push to bottom */
    }
    .page {
      background: #1c1c1c;
      padding: 1em;
      border-radius: 10px;
      border: 1px solid #333;
      transition: background 0.3s ease;
    }
    .page:hover {
      background: #222244;
    }
    .page a {
      color: #00bfff;
      font-weight: bold;
      font-size: 1.3em;
      text-decoration: none;
    }
    .page a:hover {
      text-decoration: underline;
    }
    .page code {
      color: #aaa;
      user-select: all;
    }
    #message {
      max-width: 600px;
      margin: 2em auto;
      text-align: center;
      color: #666;
      font-style: italic;
    }
  </style>
</head>
<body>
  <header>
    <h1>Endex</h1>
    <p class="version">Search EnderBK Hosted Pages</p>
  </header>

  <div id="search-container">
    <input id="search-input" type="search" placeholder="Search pages..." aria-label="Search pages" autocomplete="off" />
  </div>

  <div class="page-list" id="page-list">
    Loading pages...
  </div>

  <div id="message" role="alert" aria-live="polite"></div>

  <script>
    const repo = "enderbk0/enderbk0.github.io";
    const pageList = document.getElementById("page-list");
    const searchInput = document.getElementById("search-input");
    const message = document.getElementById("message");

    let allPages = [];

    async function loadPages() {
      try {
        const res = await fetch(`https://api.github.com/repos/${repo}/contents/`);
        const files = await res.json();
        const folders = files.filter(f => f.type === "dir");

        if (folders.length === 0) {
          pageList.innerHTML = "";
          message.textContent = "No hosted folders found.";
          return;
        }

        // Load JSON metadata from each folder with cache-busting
        const promises = folders.map(async folder => {
          const folderName = folder.name;
          const jsonURL = `https://enderbk0.github.io/${folderName}/${folderName}.json?t=${Date.now()}`;
          try {
            const res = await fetch(jsonURL);
            if (!res.ok) throw new Error("No JSON found");
            const data = await res.json();
            return {
              folderName,
              title: data.title || folderName,
              domain: data.domain || folderName,
              description: data.description || "No description."
            };
          } catch {
            // If no JSON, fallback to folderName only
            return {
              folderName,
              title: folderName,
              domain: folderName,
              description: "No description."
            };
          }
        });

        allPages = await Promise.all(promises);
        message.textContent = "";
        displayPages(allPages);
      } catch (e) {
        pageList.innerHTML = "";
        message.textContent = "Error loading pages. Please try again later.";
        console.error(e);
      }
    }

    function displayPages(pages) {
      if (pages.length === 0) {
        pageList.innerHTML = "";
        message.textContent = "No results found.";
        return;
      }

      message.textContent = "";
      pageList.innerHTML = "";

      pages.forEach(p => {
        const div = document.createElement("div");
        div.className = "page";
        div.innerHTML = `
          <a href="./${p.folderName}/" title="${p.title}">${p.title}</a><br>
          <code>enderbk://${p.domain}</code><br>
          <p>${p.description}</p>
        `;
        pageList.appendChild(div);
      });
    }

    searchInput.addEventListener("input", e => {
      const query = e.target.value.trim().toLowerCase();
      if (!query) {
        displayPages(allPages);
        return;
      }

      // Filter pages by title, domain, or description
      const filtered = allPages.filter(p =>
        p.title.toLowerCase().includes(query) ||
        p.domain.toLowerCase().includes(query) ||
        p.description.toLowerCase().includes(query)
      );

      displayPages(filtered);
    });

    loadPages();
  </script>
</body>
</html>
